<template language="js-template">
    <extend-head>
        <title>Auftragsbriefing</title>
    </extend-head>
    <page class="light-mode">
        <backendtopmenu-component type="component" data-name="/$backendtopmenu"></backendtopmenu-component>

        <section class="page-content briefing">


            <section class="grid">
                <article>

                    <div class="briefing-content">

                        <h2>${text.title}</h2>

                        ${text.briefing}
                        <div id=editor style="margin-bottom: 23px"></div>

                        <div style="display: none" id="content">
                            <h3>Hello ProseMirror</h3>

                            <p>This is editable text. You can focus it and start typing.</p>

                            <p>To apply styling, you can select a piece of text and manipulate
                                its styling from the menu. The basic schema
                                supports <em>emphasis</em>, <strong>strong
                                    text</strong>, <a href="http://marijnhaverbeke.nl/blog">links</a>, <code>code
                          font</code>, and <img src="/img/smiley.png"> images.</p>

                            <p>Block-level structure can be manipulated with key bindings (try
                                ctrl-shift-2 to create a level 2 heading, or enter in an empty
                                textblock to exit the parent block), or through the menu.</p>

                            <p>Try using the “list” item in the menu to wrap this paragraph in
                                a numbered list.</p>
                        </div>
                        <div class="button-container">
                            <label class="checkb"><input type="checkbox" name="gelesen" /> habe das Briefing gelesen und
                                verstanden</label>
                            <button type="submit" data-name="/$text/submit" class="submit">Verstanden :)</button>
                        </div>
                    </div>


                </article>

            </section>

        </section>

        <bottommenu-component data-name="/$bottommenu"></bottommenu-component>
    </page>
</template>


<style language="scss" scope=".briefing">
    @import "/css/backend.css";
</style>

<script language="js">


    import { backendtopmenu } from '../component/backendtopmenu';

    import { EditorState } from "../deps/prosemirror-state";
    import { EditorView } from "../deps/prosemirror-view";
    import { Schema, DOMParser } from "../deps/prosemirror-model";
    import { schema } from "../deps/prosemirror-schema-basic";
    import { addListNodes } from "../deps/prosemirror-schema-list";
    import { exampleSetup } from "../deps/prosemirror-example-setup";


    export let write = {
        lazyLoading: false,
        mounted() {
            //  console.log("mounted", this);

        },
        components:
        {
            "backendtopmenu-component": "backendtopmenu#mainmenu",
            "bottommenu-component": "bottommenu#footermenu"
        },
        data(cb, env) {

            return this.createStore("text",
                {
                    "versions": [],
                    "_id": "6065ffd3d65ede005e7cf9af",
                    "data": null,
                    "briefing": "Bitte schreibe mir einen kurzen Text",
                    "published_at": "2021-04-01T17:16:04.992Z",
                    "createdAt": "2021-04-01T17:16:03.151Z",
                    "updatedAt": "2021-04-04T13:14:42.291Z",
                    "__v": 0,
                    "project": {
                        "sourcetype": null,
                        "_id": "6065fc7327b6b3004e467327",
                        "name": "Business Profile schreiben",
                        "briefing": "<h3>Lieber Autor, </h3>\n\n<p>in diesem Job sollen wir Unternehmenstexte für die zukünftigen Webseiten verschiedener Unternehmen erstellen. \n\nUnser Kunde ist ein Dienstleister, der Ärzten, Handwerkern etc. Webseiten-Pakete verkauft. Wir erstellen die Texte für die Pakete mit vier Kategorien (meist „Startseite“, „Über uns“, „Philosophie“ und „Leistungen“).</p>\n\n<p>Vielleicht kennst du diesen Job bereits – wir haben ihn neu gebaut und einen API-Job generiert. Das bedeutet, dass der Kunde die Vorgaben direkt in den Job schickt und die fertigen Texte nach Überprüfung durch unsere Qualitätsmanager direkt zurück erhält.</p>\n\n<p>Wir haben vertraglich festgelegt, dass wir die Texte innerhalb von 6 Werktagen an den Kunden zurück schicken, die Lieferzeiten waren bisher zu lange. Ich bin sehr zuversichtlich, dass wir das zusammen schaffen! :)</p>\n\n\n \n![ak.png](/uploads/ak_f19a214172.png)\n",
                        "published_at": "2021-04-01T17:02:06.913Z",
                        "createdAt": "2021-04-01T17:01:39.499Z",
                        "updatedAt": "2021-04-04T13:14:42.292Z",
                        "__v": 0,
                        "wordcent": 2.3,
                        "input": null,
                        "output": null,
                        "id": "6065fc7327b6b3004e467327"
                    },
                    "title": "sdsdd",
                    "textLatest": "hlk fjlkjlfghlkgfh klgfk gfhfghgh fghgfh",
                    "validation": null,
                    "id": "6065ffd3d65ede005e7cf9af"
                }
            ).db().findText(this.environment.view.path().split("/").pop()).then(function (res) {
                let { data, model } = res;

                //  model._data.briefing = data;
                return data;
            });
        },
        interactions() {
            return {
                "write": {
                    "postRender": function (comp) {
                        this.mountComponent("backendtopmenu#mainmenu", backendtopmenu, (stores, data, component) => {
                            this.sharedComponents["backendtopmenu#mainmenu"] = component;
                        });


                        // Mix the nodes from prosemirror-schema-list into the basic schema to
                        // create a schema with list support.
                        const mySchema = new Schema({
                            nodes: addListNodes(schema.spec.nodes, "paragraph block*", "block"),
                            marks: schema.spec.marks
                        });

                        window.view = new EditorView(document.querySelector("#editor"), {
                            state: EditorState.create({
                                doc: DOMParser.fromSchema(mySchema).parse(document.querySelector("#content")),
                                plugins: exampleSetup({ schema: mySchema })
                            })
                        });


                    }
                },
                "tab": {
                    "click"(sender, dataStore) {
                        sender.ev.preventDefault();
                        let tabName = sender.field.$el.getAttribute("data-ref").split("/")[1];
                        let tab = document.querySelector('#' + tabName);
                        document.querySelectorAll(".tab").forEach(e => e.classList.remove("selected"));
                        tab.classList.add("selected");

                        document.querySelectorAll(".filters li").forEach(e => e.classList.remove("selected"));
                        dataStore.tab = tabName;
                        sender.field.$el.classList.add("selected");
                    }
                },
                "/$tasklist/clickItem": {
                    "click"(sender, dataStore) { //address specific element in dom
                        let index = parseInt(sender.field.$el.getAttribute("data-index"));
                        dataStore.items.some((v, k) => {
                            if (v.id == index) {
                                dataStore.items[k].status = !dataStore.items[k].status;
                                return true;
                            }
                        });
                    }
                },
                "name": {
                    "input"(sender, dataStore) {
                        let index = parseInt(sender.field.$el.getAttribute("data-index"));
                        for (let k in dataStore.items) {
                            let v = dataStore.items[k];
                            if (v.id == index) {
                                dataStore.items[k].label = sender.field.$el.innerText;
                            }
                        }
                    }
                },
                "/$tasklist/deleteItem": {
                    "click"(sender, dataStore) { //address specific element in dom
                        let index = parseInt(sender.field.$el.getAttribute("data-index"));
                        dataStore.items.some((v, k) => {
                            if (v.id == index) {
                                delete dataStore.items[k];
                                return true;
                            }
                        });
                    }
                },
                "/$tasklist/items": {
                    "change"(sender, dataStore) {
                        console.log(dataStore);
                    }
                },
                "/$tasklist/name": {
                    "keyup#tasklist-myinput"(sender, dataStore) { //address specific element in dom
                        dataStore.name = sender.field.getValue();

                        if (sender.ev.keyCode === 13) {
                            dataStore.items.push({
                                id: dataStore.items.length,
                                label: dataStore.name,
                                status: false
                            });
                        }
                    }
                }
            }
        }

    }

</script>