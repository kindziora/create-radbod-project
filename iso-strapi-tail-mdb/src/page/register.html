<template language="js-template">
  <extend-head>
    <title>${_t("Hier kannst du dich einloggen")}</title>
  </extend-head>
  <page>
    <topmenu-component data-name="/$topmenu"></topmenu-component>

    <section>
      <form id="register">
        <div class="step1">
          <h2>Persönliche Daten</h2>
          <div class="container">

            <div class="item biefroest">
              <div class="triangle-right"></div>
            </div>

            <div class="item">

              <label for="vname">Vorname</label>
              <input id="vname" data-name="/$user/vname" name="forename" tabindex="0" required
                data-validations="required_validator" />

              <label for="street">Straße</label>
              <div class="address">
                <input id="street" name="street" placeholder="${_t('Straßenname')}" data-name="/$user/street" required
                  data-validations="required_validator" />
                <input id="nr" name="number" placeholder="${_t('Nr.')}" type="number" data-name="/$user/nr" required
                  data-validations="required_validator" />
              </div>
              <label for="country">Land</label>
              <select id="country" name="country" data-name="/$user/country" required
                data-validations="required_validator"></select>

              <label for="bname">Benutzername</label>
              <input id="bname" name="username" data-name="/$user/bname" required
                data-validations="required_validator" />

              <label for="passwd">Passwort</label>
              <input type="password" data-name="/$user/password" id="passwd" required
                pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*_=+-]).{8,12}$" />
            </div>

            <div class="item">
              <label for="nname">Nachname</label>
              <input id="nname" name="surname" data-name="/$user/nname" required
                data-validations="required_validator" />

              <label for="street">Wo?</label>
              <div class="location">
                <input id="pcode" name="postalcode" placeholder="${_t('PLZ')}" data-name="/$user/pcode" type="number"
                  required data-validations="required_validator" />
                <input id="city" name="city" placeholder="${_t('Stadt')}" data-name="/$user/city" required
                  data-validations="required_validator" />
              </div>

              <label for="birthday">Geburtsdatum</label>
              <input id="birthday" name="birthday" data-name="/$user/birthday" type="date" />

              <label for="email">E-Mail</label>

              <input id="email" name="email" type="email" data-name="/$user/email" required
                data-validations="mail_validator,required_validator" />

              <span data-name="/_state/$user/email" class="msg ${ change.value.msg ? 'error':''}">${ change.value.msg ?
                change.value.msg.map(function(e){return e}) : ""
                }</span>

              <label for="passwdr">Passwort wiederholen</label>
              <input type="password" data-name="/$user/passwordr" id="passwdr" required
                pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*_=+-]).{8,12}$" />


            </div>

          </div>
        </div>

        <div class="step2">
          <h2>Fähigkeiten</h2>

          <div class="container step2">
            <div class="item biefroest">
              <div class="triangle-right"></div>
            </div>

            <div class="item">

              <label for="skills">Lieblings-Themen</label>
              <select multiple id="skills" name="skills" data-name="/$user/skills" required
                data-validations="required_validator"></select>

              <label for="skills">SEO Erfahrung <span class="seometer" data-name="/$user/seoLevel"
                  data-view="seometer">keine</span></label>
              <div class="slidecontainer">
                <input type="range" min="1" max="100" value="0" data-name="/$user/seoLevel" class="slider" id="myRange">
              </div>

            </div>

            <div class="item">
              <label for="langs">Sprachfähigkeiten</label>
              <select multiple id="langs" name="langs" data-name="/$user/langs"></select>

            </div>

          </div>

        </div>
        <div>
          <div class="step-container s">
            <span class="step active" data-index="1" data-events="step:click">1</span>
            <span class="step" data-index="2" data-events="step:click">2</span>
            <span class="step" data-index="3" data-events="step:click">3</span>
          </div>
        </div>

        <div class="button-container">
          <button type="submit" data-name="/$user/submit">Absenden</button>
        </div>

      </form>
    </section>
    <bottommenu-component data-name="/$bottommenu"></bottommenu-component>


  </page>
</template>

<style language="scss">
  form {

    @import "/css/slimselect.css";

    display: grid;
    justify-content: center;
    align-content: center;


    .slidecontainer {

      display: flex;

      .slider {
        background: linear-gradient(to right, #ffffff, #fae5bd, rgb(75, 243, 103), #004700);
        flex-grow: 1;
        margin-right: 6px;
      }

      .slider:active {
        transform: translateY(0);
      }

      .slider:focus {
        box-shadow: none;
      }

      .slider::-webkit-slider-thumb {
        margin-top: -10px;
        -webkit-appearance: none;
        /* Override default look */
        appearance: none;
        width: 29px;
        /* Set a specific slider handle width */
        height: 29px;
        /* Slider handle height */
        background: #718072;
        cursor: pointer;
        /* Cursor on hover */
      }

      .slider::-moz-range-thumb {
        margin-top: -10px;
        width: 29px;
        /* Set a specific slider handle width */
        height: 29px;
        /* Slider handle height */
        background: #718072;
        cursor: pointer;
        /* Cursor on hover */
      }

    }

    .seometer {
      font-weight: 600;
    }

    .step-container {
      text-align: center;
      margin: 40px;
    }

    #country option {
      display: none;
    }

    .ss-main .ss-single-selected {
      height: 38px;
      background-color: #e6e6e6;
      margin-right: 0;
      margin-bottom: 6px;
      width: 100%;
    }

    .ss-multi-selected {
      margin-bottom: 6px;
    }

    .ss-main .ss-multi-selected .ss-values .ss-value {
      font-size: inherit;
    }

    .ss-main .ss-multi-selected .ss-add {
      margin: auto 10px auto 0;
    }

    .ss-main {
      display: flex;
      max-width: fit-content;
      min-width: 267px;
    }

    .address {
      display: flex;

      input:nth-child(1) {
        width: 11.8em;
      }

      input:nth-child(2) {
        width: 2em;
      }
    }

    .location {
      display: flex;

      input:nth-child(1) {
        width: 4.8em;
      }

      input:nth-child(2) {
        width: 9em;
      }
    }

    .triangle-right {
      transition: all ease 500ms;
      transition-property: margin-left, margin-top, border-color;
      z-index: 1;
      position: absolute;
      margin-top: 21px;
      margin-left: -6px;
      width: 0;
      height: 0;
      border-radius: 24px;
      border-top: 25px solid transparent;
      border-left: 50px solid #66c166;
      border-bottom: 25px solid transparent;
      opacity: 0.78;
    }

    .triangle-right.triangle-error {
      border-left: 50px solid red;
    }



    /* Make circles that indicate the steps of the form: */
    .step {
      cursor: pointer;
      height: 2em;
      width: 2em;
      margin: 0 0.5em;
      background-color: #bbbbbb;
      border: none;
      border-radius: 50%;
      display: inline-block;
      opacity: 0.5;
      line-height: 2em;
      font-weight: 400;
      box-shadow: 0px 3px 7px #737171;
    }

    /* Mark the active step: */
    .step.active {
      opacity: 1;
      font-weight: 800;
    }

    /* Mark the steps that are finished and valid: */
    .step.finish {
      background-color: #4CAF50;
    }

    .container {
      position: relative;
      width: auto;
      display: grid;
      grid-template-columns: 20px 1fr 1fr;
      grid-template-rows: 1fr 0fr;
      gap: 0px 1.5em;
      grid-template-areas:
        ". . ."
        "s s s";

      @media only screen and (max-width: 640px) {
        flex-direction: column;
        display: flex;
      }
    }

    .s {
      grid-area: s;
    }

    .item {
      min-height: auto;

      @media only screen and (max-width: 640px) {
        width: 100%;
      }
    }

    .error {
      box-shadow: #f31010 0px 0px 4px 0px;
      border: 1px solid red;
      display: block;
    }

    span.msg {
      position: relative;
      background-color: #fbfbd7;
      display: block;
    }

    .biefroest {
      background-image: url("img/register/biefrost_thin.jpg");
      background-size: cover;
      background-position-x: center;
    }
  }
</style>

<script language="js">

  import { magic_form } from '../middleware/magic_form';
  import { mail_validator } from '../middleware/validator/email';
  import { required_validator } from '../middleware/validator/required';
  import { getParent } from '../middleware/domHelper';


  export let register = {
    views: {
      seometer: function (args) {
        let { user } = args;
        let seoLevel = ["keine", "wenig", "beginner", "mittel", "fortgeschritten", "Experte"];
        return seoLevel[parseInt(user.seoLevel / (100 / (seoLevel.length - 1)))];
      }
    },
    mounted() {

      console.log("mounted", this);

      window.onresize = function () {
        document.querySelector(".triangle-right").style.display = "none";
      };
    },
    components: {
      "topmenu-component": "topmenu#mainmenu",
      "bottommenu-component": "bottommenu#footermenu"
    },
    data() {
      return this
        .createStore("user", { name: "user login" })
        .addValidations({ mail_validator, required_validator });
    },
    interactions() {
      return magic_form.call(this, {
        "register": {
          postRender() {
            import('../deps/slimselect.js')
              .then((slimSelect) => {

                import('/page/i18n/de_DE/countries.js')
                  .then((module) => {
                    if (typeof window.countryS === "undefined")
                      window.countryS = new slimSelect.default({
                        select: '#country',
                        data: module.countries
                      });
                  });

                import('/page/i18n/de_DE/topics.js')
                  .then((module) => {
                    new slimSelect.default({
                      select: '#skills',
                      data: module.topics
                    });
                  });

                import('/page/i18n/de_DE/langs.js')
                  .then((module) => {
                    new slimSelect.default({
                      select: '#langs',
                      data: module.langs
                    });
                  });
              });
          }
        },
        "step": {
          click(change, state) {
            change.ev.preventDefault();
            alert("click " + change.field.$el.getAttribute("data-index"));
          }
        },
        "/$user/submit": {
          click(change, state) {
            change.ev.preventDefault();
            alert("SUBMIT");
          }
        },
        "/_state/$user/email/msg": {
          change(change, state) {
            if (!state.isValid) {
              document.querySelector("#email").classList.add("error");
            } else {
              document.querySelector("#email").classList.remove("error");
            }
            console.log(change, state);
          }
        },
        "/_state": {
          change(change, state) {
            if (document.activeElement) {
              let $elTriangle = getParent(document.activeElement, '.container');
              if (document.querySelector("#register") && $elTriangle
                && document.querySelector("#register").contains(document.activeElement)
                && document.activeElement.tagName !== "BUTTON") {

                $elTriangle = $elTriangle.querySelector(':scope .triangle-right');
                
                $elTriangle.style.display = "block";
                if (state.isValid) {
                  $elTriangle.style.marginTop = (document.activeElement.offsetTop - 5) + "px";
                  $elTriangle.style.marginLeft = (document.activeElement.offsetLeft - 45) + "px";
                  $elTriangle.classList.remove("triangle-error");
                } else {
                  $elTriangle.style.marginTop = (document.activeElement.offsetTop - 5) + "px";
                  $elTriangle.style.marginLeft = (document.activeElement.offsetLeft - 45) + "px";
                  $elTriangle.classList.add("triangle-error");
                }
              }
            }


          }
        }

      }, "/$user", function (data) {

        console.log("CHANGE PLEASE BACKEND SYNC", data)

      });
    },
    translations() {
      return {};
    }
  }
</script>